<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>One Sentence For The Future Us</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="day-page">
    <div class="day-content">
        <div class="day-header">
            <h2 id="fsTitle">One Sentence For The Future Us</h2>
            <p class="subtitle">Write one sentence and download the card.</p>
            <a id="fsFormBack" class="back-button" href="bouquet.html" style="margin-top:8px; display:inline-block;">Back</a>
        </div>

        <div class="future-area">
            <form id="fsForm" class="future-form" autocomplete="off">
                <textarea name="sentence" id="sentence" rows="3" required maxlength="200" style="resize:vertical; padding:10px 12px; border-radius:6px; border:1px solid rgba(139,115,85,0.15); font-family:Georgia, serif;"></textarea>

                <div style="margin:12px 0 0; text-align:center;">
                    <button type="submit" class="special-button">Generate Card</button>
                    <button type="button" id="resetFs" class="back-button">Reset</button>
                </div>
            </form>

            <div id="fsResult" style="display:none; margin-top:18px;">
                <div style="text-align:center; margin-bottom:8px;">
                    <a id="backToDay" class="back-button result-back" href="#">Back to Day</a>
                </div>

                <div class="future-card" id="fsCardContainer" aria-live="polite"></div>

                <div style="margin-top:12px; text-align:center;">
                    <button id="fsDownload" class="special-button">Download PNG</button>
                    <button id="fsEdit" class="back-button">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="bgMusic" loop playsinline webkit-playsinline preload="auto">
        <source src="" type="audio/mpeg">
    </audio>

    <script src="../js/future-sentence.js"></script>
    <script>
        const MUSIC_KEY = 'valentine_music_state';
        
        // Auto-play background music with day-specific song
        window.addEventListener('DOMContentLoaded', () => {
            const audio = document.getElementById('bgMusic');
            const urlParams = new URLSearchParams(window.location.search);
            const day = urlParams.get('day');
            
            // Set the correct song based on the day
            if (day) {
                audio.querySelector('source').src = `../songs/day${day}.mp3`;
                audio.load();
            }
            
            audio.volume = 0.3;
            
            // Restore audio state if exists
            const savedState = sessionStorage.getItem(MUSIC_KEY);
            if (savedState) {
                const state = JSON.parse(savedState);
                audio.currentTime = state.time || 0;
            }
            
            // iOS Safari: Try to play immediately
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(() => {
                    // If autoplay fails, add invisible tap-to-start for iOS
                    const tapOverlay = document.createElement('div');
                    tapOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;cursor:pointer;';
                    tapOverlay.addEventListener('click', () => {
                        audio.play();
                        tapOverlay.remove();
                    }, {once: true});
                    document.body.appendChild(tapOverlay);
                });
            }
        });
        
        // Save audio state before leaving the page
        window.addEventListener('beforeunload', () => {
            const audio = document.getElementById('bgMusic');
            if (audio && !audio.paused) {
                sessionStorage.setItem(MUSIC_KEY, JSON.stringify({
                    time: audio.currentTime,
                    playing: true
                }));
            }
        });
        
        // Save or clear state when clicking links
        document.addEventListener('click', (e) => {
            const link = e.target.tagName === 'A' ? e.target : e.target.closest('a');
            if (link) {
                const href = link.getAttribute('href');
                if (href && href.includes('index.html')) {
                    sessionStorage.removeItem(MUSIC_KEY);
                } else {
                    const audio = document.getElementById('bgMusic');
                    if (audio && !audio.paused) {
                        sessionStorage.setItem(MUSIC_KEY, JSON.stringify({
                            time: audio.currentTime,
                            playing: true
                        }));
                    }
                }
            }
        });
    </script>
</body>
</html>