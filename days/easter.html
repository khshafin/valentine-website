<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Letter â€” Assemble</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="day-page">
        <div class="day-content">
            <div class="day-header">
                <h2>A Secret.</h2>
                <p class="subtitle">Or Is It?</p>
            </div>

            <div class="easter-stage">
                <div class="easter-grid" id="easterGrid"></div>

                <div class="assemble-area" id="assembleArea">
                    <div class="assembled-text" id="assembledText" aria-live="polite"></div>
                    <button id="replayButton" class="special-button">Replay</button>
                </div>
            </div>

                <a href="letter.html" class="back-button">Back</a>
        </div>
    </div>

    <script src="../js/egg-visibility.js"></script>
    <script src="../js/easter.js"></script>

    <audio id="bgMusic" loop playsinline webkit-playsinline preload="auto">
        <source src="../songs/day14.mp3" type="audio/mpeg">
    </audio>

    <script>
        const MUSIC_KEY = 'valentine_music_state';
        window.addEventListener('DOMContentLoaded', () => {
            const audio = document.getElementById('bgMusic');
            audio.volume = 0.3;

            // Restore saved state if exists
            const saved = sessionStorage.getItem(MUSIC_KEY);
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    if (state.time) audio.currentTime = state.time;
                } catch (e) {}
            }

            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(() => {
                    const tapOverlay = document.createElement('div');
                    tapOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;cursor:pointer;';
                    tapOverlay.addEventListener('click', () => {
                        audio.play();
                        tapOverlay.remove();
                    }, { once: true });
                    document.body.appendChild(tapOverlay);
                });
            }
        });

        // Save audio state before leaving the page
        window.addEventListener('beforeunload', () => {
            const audio = document.getElementById('bgMusic');
            if (audio && !audio.paused) {
                sessionStorage.setItem(MUSIC_KEY, JSON.stringify({
                    time: audio.currentTime,
                    playing: true
                }));
            }
        });

        // Also save state when clicking links
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                const audio = document.getElementById('bgMusic');
                if (audio && !audio.paused) {
                    sessionStorage.setItem(MUSIC_KEY, JSON.stringify({
                        time: audio.currentTime,
                        playing: true
                    }));
                }
            }
        });
    </script>
</body>
</html>